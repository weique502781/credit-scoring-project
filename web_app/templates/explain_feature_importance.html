<!-- 特征重要性页面 -->
{% extends "base.html" %}

{% block title %}Feature Importance - Credit Scoring System{% endblock %}

{% block extra_css %}
<style>
    .importance-bar {
        height: 25px;
        background-color: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
        position: relative;
    }

    .importance-fill {
        height: 100%;
        border-radius: 12px;
        transition: width 1s ease-in-out;
        background: linear-gradient(90deg, #3498db, #2ecc71);
    }

    .importance-label {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .importance-value {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: 600;
    }

    .feature-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .feature-card:hover {
        border-color: #3498db;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .model-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }

    .model-tab {
        padding: 10px 20px;
        border: none;
        background: none;
        font-weight: 500;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .model-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
    }

    .model-tab:hover:not(.active) {
        color: #495057;
        border-bottom-color: #adb5bd;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-label {
        opacity: 0.9;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Feature Importance Analysis</h5>
            </div>
            <div class="card-body">
                <p class="lead">
                    Discover which features have the greatest impact on credit risk predictions.
                </p>
                <p class="text-muted">
                    Feature importance shows how much each feature contributes to the model's predictions.
                    Higher importance means the feature has more influence on the decision.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Model Selection Tabs -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3">Select Model to Analyze:</h6>
                <div class="model-tabs">
                    <button class="model-tab active" data-model="all">
                        All Models Comparison
                    </button>
                    {% for model_name, plot_html in importance_plots.items() %}
                    <button class="model-tab" data-model="{{ model_name }}">
                        {{ model_name.replace('_', ' ').title() }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feature Importance Visualization -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div id="importance-visualization">
                    <!-- All models comparison plot will go here -->
                    <div class="text-center p-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5>Select a model to view feature importance</h5>
                        <p class="text-muted">Click on a model tab above to see its feature importance analysis</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model-specific Importance Plots -->
{% for model_name, plot_html in importance_plots.items() %}
<div class="model-plot d-none" id="plot-{{ model_name }}">
    {{ plot_html|safe }}
</div>
{% endfor %}

<!-- Top Features Summary -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="fas fa-star me-2"></i>Most Important Features Across Models</h6>
            </div>
            <div class="card-body">
                {% if feature_importance_data %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Description</th>
                                <th>Average Importance</th>
                                <th>Models Where Important</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feature in feature_importance_data[:10] %}
                            <tr>
                                <td>
                                    <strong>{{ feature.feature }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if feature.feature in dataset_info.features %}
                                        {{ dataset_info.features[feature.feature].description }}
                                        {% else %}
                                        Feature information not available
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                            <div class="progress-bar"
                                                 role="progressbar"
                                                 style="width: {{ feature.score * 100 }}%">
                                            </div>
                                        </div>
                                        <span>{{ "%.3f"|format(feature.score) }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">All</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <h6>Feature importance data not available</h6>
                    <p class="text-muted small">
                        The feature importance analysis needs to be run first. Check if the analysis script has been executed.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="stat-card">
            <div class="stat-value">{{ total_models }}</div>
            <div class="stat-label">Models Analyzed</div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Interpretation Guide</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-circle text-primary me-2"></i>
                        <strong>Checking Account:</strong> Most important - indicates financial stability
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-circle text-success me-2"></i>
                        <strong>Credit Amount:</strong> Higher amounts = higher risk
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-circle text-warning me-2"></i>
                        <strong>Duration:</strong> Longer loans = more uncertainty
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-circle text-danger me-2"></i>
                        <strong>Credit History:</strong> Past behavior predicts future
                    </li>
                    <li>
                        <i class="fas fa-circle text-secondary me-2"></i>
                        <strong>Age & Employment:</strong> Stability indicators
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Feature Details -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Key Features Explained</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% set key_features = ['checking_account', 'amount', 'duration', 'credit_history', 'age'] %}
                    {% for feature_name in key_features %}
                    {% if feature_name in dataset_info.features %}
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="feature-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">{{ dataset_info.features[feature_name].name }}</h6>
                                <span class="badge bg-primary">{{ loop.index }}</span>
                            </div>
                            <p class="small text-muted mb-3">
                                {{ dataset_info.features[feature_name].description }}
                            </p>

                            <div class="mb-2">
                                <small class="text-muted">Impact on Credit Risk:</small>
                                <div class="importance-bar">
                                    <div class="importance-fill" style="width: {{ 100 - loop.index0 * 15 }}%">
                                        <span class="importance-label">High Impact</span>
                                        <span class="importance-value">{{ 100 - loop.index0 * 15 }}%</span>
                                    </div>
                                </div>
                            </div>

                            {% if 'categories' in dataset_info.features[feature_name] %}
                            <small class="text-muted">Possible Values:</small>
                            <div class="mt-2">
                                {% for code, desc in dataset_info.features[feature_name].categories.items()|list|slice(0, 3) %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ desc }}</span>
                                {% endfor %}
                                {% if dataset_info.features[feature_name].categories|length > 3 %}
                                <span class="badge bg-secondary">+{{ dataset_info.features[feature_name].categories|length - 3 }} more</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Feature importance can vary between different machine learning algorithms.
                    Tree-based models often show different importance patterns compared to linear models.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Tab functionality
    $('.model-tab').click(function() {
        const model = $(this).data('model');

        // Update active tab
        $('.model-tab').removeClass('active');
        $(this).addClass('active');

        // Show appropriate content
        if (model === 'all') {
            $('#importance-visualization').html(`
                <div class="text-center p-5">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5>Comparing Feature Importance Across Models</h5>
                    <p class="text-muted">Different models weight features differently based on their algorithms</p>

                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Tree-based Models</h6>
                                    <p class="small text-muted">
                                        Decision Trees and AdaBoost focus on features that best split the data.
                                        They often highlight non-linear relationships.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Linear Models</h6>
                                    <p class="small text-muted">
                                        Logistic Regression and SVM with linear kernel use feature coefficients.
                                        They assume linear relationships with the target.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        } else {
            // Hide all plots
            $('.model-plot').addClass('d-none');

            // Show selected plot
            $(`#plot-${model}`).removeClass('d-none');

            // Move plot to visualization area
            const plotContent = $(`#plot-${model}`).html();
            $('#importance-visualization').html(plotContent);

            // Update title
            $('#importance-visualization').prepend(`
                <h6 class="mb-3">${model.replace('_', ' ').title()} - Feature Importance</h6>
            `);
        }
    });

    // Initialize with first model if available
    {% if importance_plots %}
    $('.model-tab[data-model!="all"]').first().click();
    {% endif %}

    // Animate progress bars
    $('.progress-bar').each(function() {
        const width = $(this).css('width');
        $(this).css('width', '0');

        setTimeout(() => {
            $(this).animate({
                width: width
            }, 1000);
        }, 500);
    });

    // Add hover effects to feature cards
    $('.feature-card').hover(
        function() {
            $(this).find('.importance-fill').css('transform', 'scaleY(1.2)');
        },
        function() {
            $(this).find('.importance-fill').css('transform', 'scaleY(1)');
        }
    );
});
</script>
{% endblock %}