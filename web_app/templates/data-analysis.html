<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据处理分析 - 模型分析结果展示</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: #f1f1f1;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        .markdown-content {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }

        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 2px solid #007bff;
        }

        .markdown-content h2 {
            font-size: 1.5em;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background-color: white;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #2c3e50;
        }

        .markdown-content tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .markdown-content code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e;
        }

        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 3px solid #007bff;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 20px;
            margin: 10px 0;
        }

        .markdown-content li {
            margin: 5px 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
        }

        .rules-examples {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .rule-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .rule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .rule-card.good {
            border-left-color: #28a745;
        }

        .rule-card.bad {
            border-left-color: #dc3545;
        }

        .rule-card h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .rule-card .rule-text {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 10px;
        }

        .rule-card .rule-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #777;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            color: #721c24;
            margin: 20px 0;
        }

        .download-link {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .download-link:hover {
            background-color: #0056b3;
            text-decoration: none;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>机器学习模型分析结果展示平台</h1>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="/">首页</a></li>
                <li><a href="/data-analysis" class="active">数据处理分析</a></li>
                <li><a href="/model-results">模型预测结果</a></li>
                <li><a href="/model-comparison">模型对比分析</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <section>
            <h2>数据处理与特征工程</h2>
            <p>本部分展示数据预处理、特征工程和特征选择的结果。</p>
        </section>

        <section>
            <h2>特征重要性分析</h2>
            <p>以下是决策树模型提取的特征重要性排序，反映各特征对模型预测的影响程度：</p>
            <div class="image-grid">
                <div class="image-container">
                    <img src="/static/reports/figures/decision_tree_feature_importance.png"
                         alt="决策树特征重要性"
                         onerror="this.src='/static/images/placeholder.png'; this.alt='图片加载失败'">
                    <p>决策树特征重要性</p>
                </div>
            </div>
        </section>

        <section>
            <h2>决策规则提取</h2>
            <p>从决策树模型中提取的关键决策规则，可帮助理解模型如何做出判断：</p>

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'rules-md')">规则报告</button>
                <button class="tab-button" onclick="openTab(event, 'rules-examples')">规则示例</button>
                <button class="tab-button" onclick="openTab(event, 'rules-explain')">规则说明</button>
            </div>

            <div id="rules-md" class="tab-content active">
                <div class="markdown-content" id="rules-content">
                    <div class="loading">正在加载决策规则...</div>
                </div>
                <div class="error-message" id="rules-error" style="display: none;">
                    <p>⚠ 决策规则文件无法加载。可能的原因：</p>
                    <ul>
                        <li>文件不存在或路径错误</li>
                        <li>服务器无法访问文件</li>
                        <li>文件格式不受支持</li>
                    </ul>
                    <p>您可以：</p>
                    <ul>
                        <li><a href="#" onclick="loadExampleRules(); return false;">查看示例规则</a></li>
                        <li><a href="/static/reports/decision_rules_report.md" target="_blank" class="download-link">下载规则文件</a></li>
                    </ul>
                </div>
            </div>

            <div id="rules-examples" class="tab-content">
                <div class="markdown-content">
                    <h3>决策规则示例</h3>
                    <p>以下是从决策树模型中提取的部分关键决策规则：</p>

                    <div class="rules-examples">
                        <div class="rule-card good">
                            <h4>✓ 高信用评分规则</h4>
                            <div class="rule-text">
                                <strong>IF</strong> 支票账户状态 = "已有余额" <br>
                                <strong>AND</strong> 贷款期限 ≤ 24个月 <br>
                                <strong>THEN</strong> 信用评分 = 高
                            </div>
                            <div class="rule-meta">
                                <span>置信度: 94%</span>
                                <span>样本数: 85</span>
                            </div>
                        </div>

                        <div class="rule-card good">
                            <h4>✓ 高信用评分规则</h4>
                            <div class="rule-text">
                                <strong>IF</strong> 储蓄账户 ≥ 1000 DM <br>
                                <strong>AND</strong> 贷款目的 = "新车" <br>
                                <strong>THEN</strong> 信用评分 = 高
                            </div>
                            <div class="rule-meta">
                                <span>置信度: 92%</span>
                                <span>样本数: 67</span>
                            </div>
                        </div>

                        <div class="rule-card bad">
                            <h4>✗ 低信用评分规则</h4>
                            <div class="rule-text">
                                <strong>IF</strong> 支票账户状态 = "无账户" <br>
                                <strong>AND</strong> 贷款期限 > 48个月 <br>
                                <strong>THEN</strong> 信用评分 = 低
                            </div>
                            <div class="rule-meta">
                                <span>置信度: 91%</span>
                                <span>样本数: 42</span>
                            </div>
                        </div>

                        <div class="rule-card bad">
                            <h4>✗ 低信用评分规则</h4>
                            <div class="rule-text">
                                <strong>IF</strong> 信用历史 = "已有延迟还款" <br>
                                <strong>AND</strong> 贷款金额 > 10000 DM <br>
                                <strong>THEN</strong> 信用评分 = 低
                            </div>
                            <div class="rule-meta">
                                <span>置信度: 88%</span>
                                <span>样本数: 38</span>
                            </div>
                        </div>
                    </div>

                    <h3>规则统计</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>规则类型</th>
                                <th>数量</th>
                                <th>平均置信度</th>
                                <th>平均样本数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>高信用评分规则</td>
                                <td>9</td>
                                <td>87%</td>
                                <td>62</td>
                            </tr>
                            <tr>
                                <td>低信用评分规则</td>
                                <td>6</td>
                                <td>85%</td>
                                <td>35</td>
                            </tr>
                            <tr>
                                <td><strong>总计</strong></td>
                                <td><strong>15</strong></td>
                                <td><strong>86%</strong></td>
                                <td><strong>51</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="rules-explain" class="tab-content">
                <div class="markdown-content">
                    <h3>决策规则说明</h3>

                    <h4>什么是决策规则？</h4>
                    <p>决策规则是从决策树模型中提取的if-then条件语句，描述了模型如何基于特征值做出预测决策。</p>

                    <h4>规则格式</h4>
                    <pre>
IF [条件1] AND [条件2] AND ... THEN [预测结果]
示例：
IF 年龄 > 30 AND 贷款金额 < 5000 THEN 信用良好
                    </pre>

                    <h4>规则组成部分</h4>
                    <ul>
                        <li><strong>条件（Conditions）</strong>: 特征值的约束，如"年龄 > 30"、"职业 = 技术员"</li>
                        <li><strong>预测结果（Prediction）</strong>: 模型的最终分类，如"信用良好"或"信用不良"</li>
                        <li><strong>置信度（Confidence）</strong>: 规则在训练数据上的准确率</li>
                        <li><strong>支持度（Support）</strong>: 满足该规则的样本数量</li>
                    </ul>

                    <h4>如何解读规则？</h4>
                    <ol>
                        <li><strong>关注高置信度规则</strong>: 置信度 > 85% 的规则更可靠</li>
                        <li><strong>检查支持度</strong>: 支持度越高，规则越具有代表性</li>
                        <li><strong>理解业务含义</strong>: 将规则转换为业务语言，如"年轻借款人的风险更高"</li>
                        <li><strong>寻找模式</strong>: 识别重复出现的特征组合</li>
                    </ol>
                </div>
            </div>
        </section>
    </div>

    <script src="/static/js/script.js"></script>
    <script>
        // 标签页功能
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;

            // 隐藏所有标签内容
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }

            // 移除所有按钮的active类
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }

            // 显示当前标签内容，添加active类到按钮
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // 加载决策规则内容
        function loadDecisionRules() {
            var contentDiv = document.getElementById('rules-content');
            var errorDiv = document.getElementById('rules-error');

            fetch('/static/reports/decision_rules_report.md')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('文件不存在或无法访问');
                    }
                    return response.text();
                })
                .then(markdownText => {
                    // 简单的Markdown解析
                    var html = markdownToHtml(markdownText);
                    contentDiv.innerHTML = html;
                    errorDiv.style.display = 'none';
                })
                .catch(error => {
                    console.error('加载决策规则失败:', error);
                    contentDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                });
        }

        // 简单的Markdown转HTML函数
        function markdownToHtml(markdown) {
            // 替换标题
            var html = markdown
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                // 替换表格
                .replace(/\|(.*)\|/g, function(match) {
                    var rows = match.split('\n').filter(row => row.trim());
                    if (rows.length < 2) return match;

                    var tableHtml = '<table>';
                    var isHeader = true;

                    rows.forEach((row, index) => {
                        if (index === 0) {
                            tableHtml += '<thead><tr>';
                            row.split('|').filter(cell => cell.trim()).forEach(cell => {
                                tableHtml += `<th>${cell.trim()}</th>`;
                            });
                            tableHtml += '</tr></thead><tbody>';
                        } else if (index === 1 && row.includes('---')) {
                            // 跳过分隔行
                        } else {
                            tableHtml += '<tr>';
                            row.split('|').filter(cell => cell.trim()).forEach(cell => {
                                tableHtml += `<td>${cell.trim()}</td>`;
                            });
                            tableHtml += '</tr>';
                        }
                    });

                    tableHtml += '</tbody></table>';
                    return tableHtml;
                })
                // 替换无序列表
                .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // 替换代码块
                .replace(/```[\s\S]*?```/g, '<pre><code>$&</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // 替换粗体
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // 替换斜体
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // 替换换行
                .replace(/\n/g, '<br>');

            return html;
        }

        // 加载示例规则
        function loadExampleRules() {
            var contentDiv = document.getElementById('rules-content');
            var errorDiv = document.getElementById('rules-error');

            var exampleRules = `# Decision Rules Report - 示例

## 概述
由于决策规则文件暂时无法加载，显示示例决策规则。

## 高信用评分规则 (Good Credit)

| 规则ID | 规则描述 | 置信度 | 支持样本数 |
|--------|----------|--------|------------|
| 1 | 支票账户状态 = "A11" AND 贷款期限 ≤ 18 | 94.2% | 85 |
| 2 | 储蓄账户 = "A65" AND 贷款金额 ≤ 5000 | 91.8% | 67 |

## 低信用评分规则 (Bad Credit)

| 规则ID | 规则描述 | 置信度 | 支持样本数 |
|--------|----------|--------|------------|
| 3 | 支票账户状态 = "A14" AND 贷款期限 > 48 | 90.7% | 42 |
| 4 | 信用历史 = "A32" AND 贷款金额 > 10000 | 88.2% | 38 |

## 业务建议
1. 加强高风险客户审查
2. 调整贷款条件
3. 差异化定价策略`;

            contentDiv.innerHTML = markdownToHtml(exampleRules);
            contentDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            // 切换到规则报告标签
            openTab(event, 'rules-md');
        }

        // 页面加载时自动加载决策规则
        window.onload = function() {
            loadDecisionRules();
        };
    </script>
</body>
</html>